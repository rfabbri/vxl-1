# Script to train a bvxm voxel world of SteepleStreet Providence video
# Author : Isabel Restrepo
# 3-26-2009


import bseg3d_batch
import os
bseg3d_batch.register_processes();
bseg3d_batch.register_datatypes();

#Delay for debugging
import time
#time.sleep(30);


class dbvalue:
  def __init__(self, index, type):
    self.id = index
    self.type = type

#options for this script
train = 1; #Train the voxel world
calculate_distances = 0; #compute l2-distances in the voxel world
save_raw = 0; #save drishti raw file of distance-grid
render = 0;   #ecpected images of distance grid
    
    
#set directory names
param_dir = "C:/Scripts/python_voxel/CapitolSiteHigh/params";


# create a directory to save results
results_dir = "/media/DATAPART1/BrandonDataFolder/ChangeDetection/Experiments";
if not os.path.isdir( results_dir + "/"):
  os.mkdir( results_dir + "/");

img_names = "Y:/video/dec/capitol_sfm/video_grey/frame_%05d.png";
cam_names = "Y:/video/dec/CapitolSiteHigh/cameras_KRT/camera_%05d.txt";
  

#create world.
print("1.------------------------------------------")
print("Creating Voxel World");
bseg3d_batch.init_process("bvxmCreateVoxelWorldProcess");
bseg3d_batch.set_params_process(param_dir + "/voxel_world_params.xml");
bseg3d_batch.run_process();
(id,type) = bseg3d_batch.commit_output(0);
world = dbvalue(id,type);
print(str(id))

if train: 

   # initializing the world
  # print("Cleaning world");
  # bseg3d_batch.init_process("bvxmCleanWorldProcess");
  # bseg3d_batch.set_input_from_db(0,world);
  # bseg3d_batch.run_process();
  nframes = 255;
  for i in range(30,nframes,1):

    print("2.------------------------------------------")
    print("Loading Camera");
    bseg3d_batch.init_process("vpglLoadPerspectiveCameraProcess");
    bseg3d_batch.set_input_string(0,cam_names % i);
    bseg3d_batch.run_process();
    (id,type) = bseg3d_batch.commit_output(0);
    cam = dbvalue(id,type);
    
    print("3.------------------------------------------")
    print("Loading Image");
    bseg3d_batch.init_process("vilLoadImageViewProcess");
    bseg3d_batch.set_input_string(0,img_names % i);
    bseg3d_batch.run_process();
    (id,type) = bseg3d_batch.commit_output(0);
    image = dbvalue(id,type);
    
    app_type = "apm_mog_grey";
    illum_bin = 0;
    scale = 0;
    
    print("4.------------------------------------------")
    print("Updating World");
    bseg3d_batch.init_process("bvxmUpdateProcess");
    bseg3d_batch.set_input_from_db(0,image);
    bseg3d_batch.set_input_from_db(1,cam);
    bseg3d_batch.set_input_from_db(2,world);
    bseg3d_batch.set_input_string(3,"apm_mog_grey");
    bseg3d_batch.set_input_unsigned(4,0);
    bseg3d_batch.set_input_unsigned(5,0);
    bseg3d_batch.run_process();
    #(id, type) = bseg3d_batch.commit_output(0);
    #prob_dens_img = dbvalue(id, type);
    
    # print("saving density image");
    # bseg3d_batch.init_process("vilSaveImageViewProcess");
    # bseg3d_batch.set_input_from_db(0,prob_dens_img);
    # bseg3d_batch.set_input_string(1, results_dir + "/density_" + str(i) + ".tiff");
    # bseg3d_batch.run_process();
    
    
    # #Every five images display expexted image
    # if ((i + 1 )%5 == 0):
  
    # print("Generating Expected Image");
    # bseg3d_batch.init_process("bvxmRenderExpectedImageProcess");
    # bseg3d_batch.set_input_from_db(0,cam); 
    # bseg3d_batch.set_input_unsigned(1,1280);
    # bseg3d_batch.set_input_unsigned(2,720);
    # bseg3d_batch.set_input_from_db(3,world);
    # bseg3d_batch.set_input_string(4,"apm_mog_grey");
    # bseg3d_batch.set_input_unsigned(5,0);
    # bseg3d_batch.set_input_unsigned(6,0);
    # bseg3d_batch.run_process();
    # (id,type) = bseg3d_batch.commit_output(0);
    # expected = dbvalue(id,type);

    # print("saving expected image");
    # bseg3d_batch.init_process("vilSaveImageViewProcess");
    # bseg3d_batch.set_input_from_db(0,expected);
    # bseg3d_batch.set_input_string(1, results_dir + "/expected_" + str(i) + ".png");
    # bseg3d_batch.run_process();

# #find the distances 
# if calculate_distances:
  # print("------------------------------------------")
  # print("Calculating l2-distances");
  # bseg3d_batch.init_process("bseg3dL2DistanceProcess");
  # bseg3d_batch.set_input_from_db(0,world);
  # bseg3d_batch.run_process();
  
  
# if save_raw:
  # print("------------------------------------------")
  # print("Saving grid");
  # bseg3d_batch.init_process("bseg3dSaveFloatGridProcess");
  # bseg3d_batch.set_input_string(0,"./synth_world/distance.vox");
  # bseg3d_batch.set_input_string(1,"./synth_world/distance.raw");
  # bseg3d_batch.run_process();

  
# if render:
  # print("------------------------------------------")
  # print("Creating Voxel World");
  # bseg3d_batch.init_process("bvxmCreateVoxelWorldProcess");
  # bseg3d_batch.set_params_process(param_dir + "/DistWorlParams.xml");
  # bseg3d_batch.run_process();
  # (id,type) = bseg3d_batch.commit_output(0);
  # world = dbvalue(id,type);
  # print(str(id))



  # for i in range(0, len(cam_fnames),1):

    # cam_name = cam_fnames[i];
    # print("------------------------------------------")
    # print("Cam: " );
    # print(str(i));
    # print("------------------------------------------")
    
    # print("------------------------------------------")
    # print("Loading Camera");
    # bseg3d_batch.init_process("vpglLoadPerspectiveCameraProcess");
    # bseg3d_batch.set_input_string(0,cam_name);
    # bseg3d_batch.run_process();
    # (id,type) = bseg3d_batch.commit_output(0);
    # cam = dbvalue(id,type);
    
    # apm_type="apm_mog_grey";
    # illum_bin = 0;
    # scale = 0;
    
    # print("---------------------------");
    # print("Generating Expected Image");
    # bseg3d_batch.init_process("bvxmRenderExpectedImageProcess");
    # bseg3d_batch.set_input_from_db(0,cam);
    # bseg3d_batch.set_input_unsigned(1,200);
    # bseg3d_batch.set_input_unsigned(2,200);
    # bseg3d_batch.set_input_from_db(3,world);
    # bseg3d_batch.set_input_string(4,apm_type);
    # bseg3d_batch.set_input_unsigned(5,illum_bin);
    # bseg3d_batch.set_input_unsigned(6,scale);
    # bseg3d_batch.run_process();
    # (id,type) = bseg3d_batch.commit_output(0);
    # expected = dbvalue(id,type);
    
    
    # print("---------------------------");
    # print("Saving Image");
    # bseg3d_batch.init_process("vilSaveImageViewProcess");
    # bseg3d_batch.set_input_from_db(0,expected);
    # bseg3d_batch.set_input_string(1,"./" + results_dir + "/expected_" + str(i) + ".png");
    # bseg3d_batch.run_process();
    
    # bseg3d_batch.remove_data(expected.id);
    
    # print("---------------------------");
    # print("Generating Expected Image");
    # bseg3d_batch.init_process("bvxmRenderExpectedImageProcess");
    # bseg3d_batch.set_input_from_db(0,cam);
    # bseg3d_batch.set_input_unsigned(1,200);
    # bseg3d_batch.set_input_unsigned(2,200);
    # bseg3d_batch.set_input_from_db(3,world);
    # bseg3d_batch.set_input_string(4,"apm_float");
    # bseg3d_batch.set_input_unsigned(5,0);
    # bseg3d_batch.set_input_unsigned(6,0);
    # bseg3d_batch.run_process();
    # (id,type) = bseg3d_batch.commit_output(0);
    # distance_img= dbvalue(id,type);
    
    # print("---------------------------");
    # print("Saving Image");
    # bseg3d_batch.init_process("vilSaveImageViewProcess");
    # bseg3d_batch.set_input_from_db(0,distance_img);
    # bseg3d_batch.set_input_string(1,"./" + results_dir + "/distance_" + str(i) + ".tiff");
    # bseg3d_batch.run_process();
    

    # bseg3d_batch.remove_data(distance_img.id);
    # bseg3d_batch.remove_data(cam.id);
    
  bseg3d_batch.remove_data(world.id);

  print("---------------------------");
  print("Saving Image");
  bseg3d_batch.init_process("vilSaveImageViewProcess");
  print("Done");



