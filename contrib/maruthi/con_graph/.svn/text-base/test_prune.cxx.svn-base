// dbgl headers
#include <dbskfg/pro/dbskfg_prune_fragments_process.h>
#include <bpro1/bpro1_parameters.h>
#include <vul/vul_file.h>
#include <vul/vul_file_iterator.h>
#include <vul/vul_reg_exp.h>

int main( int argc, char *argv[] )
{

    vcl_stringstream stream(argv[1]);
    vcl_string input_directory;
    stream>>input_directory;

    vcl_string temp=input_directory;
    unsigned int position=temp.find("_cgraph_fragments");
    vcl_string str_scale=temp.substr(position-2,2);
    vcl_stringstream sstream(str_scale);


    unsigned int scale;
    sstream>>scale;    

    // Determine Object Name
    vcl_string object_name=input_directory;
    unsigned int dir_location = object_name.find("image_pyramid");
    object_name.erase(dir_location-1);
    dir_location=object_name.find_last_of("/");
    object_name.erase(0,dir_location+1);
   

    double step=1.189207115002721;

    vcl_vector<double> scale_sizes;
    scale_sizes.push_back(1.000000000000000);
    scale_sizes.push_back(1.189207115002721);
    scale_sizes.push_back(1.414213562373095);
    scale_sizes.push_back(1.681792830507429);
    scale_sizes.push_back(2.000000000000000);
    scale_sizes.push_back(2.378414230005442);
    scale_sizes.push_back(2.828427124746189);
    scale_sizes.push_back(3.363585661014858);
    scale_sizes.push_back(3.999999999999999);
    scale_sizes.push_back(4.756828460010883);
    scale_sizes.push_back(5.656854249492378);


    dbskfg_prune_fragments_process pro;

    pro.clear_input();
    pro.clear_output();

    vul_file_iterator bn(input_directory+"/*.bin");
    
    if ( !bn())
    {
        return 0;
    }

    // Lets set the parameters
    bpro1_filepath input_file(bn(),"");
    bpro1_filepath output_folder(input_directory,"");

    vcl_vector<double> thresholds;
    thresholds.push_back(0.0);
    thresholds.push_back(0.1);
    thresholds.push_back(0.2);
    thresholds.push_back(0.3);
    thresholds.push_back(0.4);
    thresholds.push_back(0.5);
    thresholds.push_back(0.6);
    thresholds.push_back(0.7);
    thresholds.push_back(0.8);
    thresholds.push_back(0.9);
    thresholds.push_back(1.0);

    for ( unsigned int i=0; i < thresholds.size() ; ++i)
    { 
        vcl_cout<<"Working on "<<input_directory<<" at threshold "
                <<thresholds[i]<<vcl_endl;
        pro.clear();

        pro.parameters()->set_value( "-output_prefix", object_name);
        pro.parameters()->set_value("-output_folder", output_folder);
        pro.parameters()->set_value("-input_binary_file", input_file);
        pro.parameters()->set_value("-threshold", thresholds[i]);
        pro.parameters()->set_value("-scale", scale_sizes[scale]);
    
        bool status = pro.execute();

        vcl_stringstream streamer;
        streamer<<i;

        // Create names
        vcl_string output_file = input_directory+"/"+
            object_name+"_t"+streamer.str()+"_pruned_fragments.bin";
        pro.write_out_data(output_file);
    }

   
    pro.finish();

    return 0;
}
