#!/bin/sh
#
# Utility to run mcs curve-based multiview stereo reconstruction
#
# To identify an experiment, we need:
# - parameters used (copy of commandline) : commandline file
# - the stdout/stderr of the evaluation command
#     - stdout is stored
#     - stderr is currently dump into terminal. Would be better to just dump to
#     file as well, as this will be batch processed.
# - the mcs_instance file (number of views and what views)
# - the dataset (which is obtained from where the output dir is located)
# - timing info

# set this var with any identifying stamp for each experiment being run.

case $# in
  0) echo 'usage: mcs_rec  rec_dir [mcs_opts]. Call mcs_rec from the current dir of the dataset.' 1>&2; exit 2
esac
case $1 in
    -h|--help|-?) echo 'usage: mcs_rec  rec_dir [mcs_opts]. Call mcs_rec from the current dir of the dataset.' 1>&2; exit 2
esac
rec_dir=$1

# copy current dir to output so we know what dataset its for

if [ ! -d $rec_dir ]; then
  echo creating directory $rec_dir
  mkdir $rec_dir
else
  echo "mcs_rec: directory $rec_dir already exists; remove it first." 1>&2; exit 1;
fi

set -x
mynice='nice -n 2'
mytime=`which time`

if test -z "$mytime"; then
  echo 'mcs_rec: time not found.'
  exit 1
fi

pwd > $rec_dir/cwd

shift
# mcs itself prints out what mcs_instances it is using
echo "nohup $mytime $mynice mcs -outdir $rec_dir/mcs-rec $* | tee \
$rec_dir/output" > $rec_dir/commandline
nohup $mytime $mynice mcs -outdir $rec_dir/mcs-rec $* | tee $rec_dir/output
