#!/bin/sh
#
# Utility to run vox_mcs_eval multiview stereo evaluation with organized output.
#
# To identify an experiment, we need:
# - input.xml used
# - the stdout/stderr of the evaluation command
#     - stdout is stored
#     - stderr is currently dump into terminal. Would be better to just dump to
#     file as well, as this will be batch processed.
# - the mcs_instance (number of views and what views)
# - the dataset (which is obtained from where the output dir is located)



case $# in
    0) echo 'usage: mcs_eval input.xml'
esac

set -x
mynice='nice -n 2'

mytime=`which time`

if test -z "$mytime"; then
  echo 'mcs_eval: time not found.'
  exit 1
fi


# make sure input.xml is properly preety-printed before processing it.
eval_dir=`grep output_mcs_eval_folder $1 | cut -f 2 -d \"`

lastname=`echo $eval_dir | grep -o 'eval.*$'`

if [ $lastname == 'eval/' -o $lastname == 'eval' ]; then
  echo "mcs_eval: your eval_dir must denote a subdir of eval"
  exit 1
fi

if [ ! -d $eval_dir ]; then
  echo creating directory $eval_dir
  if ! mkdir $eval_dir; then
    echo mcs_eval: could not create directory $eval_dir.
    exit 1
  fi
else
  echo cleaning up $eval_dir
  rm -f $eval_dir/*
fi

# copy input.xml to eval dir
cp $1 $eval_dir

# vox_mcs_eval should itself print out what mcs_instance it is using.
nohup $mytime $mynice vox_mcs_eval -x $1  | tee $eval_dir/output
