#!/bin/bash
#
# Utility for linking contours in images.

# 1) adapt these commands and run:
# ln -s $HOME/cprg/vxlprg/lemsvpe/lemsvxl-bin/brcv/rec/dborl/algo/vox_compute_contours/dborl_compute_contours ~/bin
# cp $HOME/cprg/vxlprg/lemsvpe/lemsvxl/contrib/rfabbri/mw/scripts/dborl_compute_contours-input.xml ~/bin
# 
# 2) edit ~/bin/dborl_edge_third_order-input.xml with your parameters
#
# 3) run per usage message below

echo XXX computing contours: $@
vorlexecname=dborl_compute_contours
vorldirname=$LEMSVPE/lemsvxl-bin/bin/$vorlexecname
xmlorig="$HOME/bin/$vorlexecname-input.xml"
program=contours

myusage () { 
  echo "Usage: $0 [options] image_filename" 1>&2; 
  echo "Options: refer to the source file" 1>&2; 
}

case $# in
  0) myusage
    exit 2
    ;;
esac

while [[ $# -gt 0 ]]; do
  arg="$1"
  case $arg in
      --version|-V|-v)
        echo "VXD contours v1"
        exit 0
        ;;
      --help|-h) 
        myusage
        exit 0
        ;;
      -r|--nrad)  # overrides the value in the config file
      nrad="$2"
      shift 2
      ;;
      -l|--num_link_iters)  # overrides the value in the config file
      num_link_iters="$2"
      shift 2
      ;;
      -x|--suffix)  # override the output_extension in the config file
      suffix="$2"
      shift 2
      ;;
      -e|--edgesuffix)
      edgesuffix="$2"
      shift 2
      ;;
      -*)
      echo "$program: $arg: unknown option"
      exit 1
      ;;
      *) break;;
  esac
done

case $# in
  0) myusage
    exit 2
    ;;
esac

img_ext=`echo $1|grep -o '\.[^\.]*$'`
img_base="${1%$img_ext}"
img_dir=`dirname $1`

echo image extension: $img_ext
echo image base: $img_base

tmpfile=/tmp/$$-tmp-$vorlexecname-input.xml

# change parameters for both color and gray edge detector, since we are not sure
# which one will get used. OR hardcode to use the gray one OR change edge to use
# color

# -edgemap parameter to use existing edges

# - Linking params
#  - nrad (radius of nhood)
#  - secondary: gap (maximum pixel distance to complete)
#  - not sure: token_len (puts bounds on legal curvature)
#  - max # to group: chain size to group
#  - # iters
# - Extract contours
#   - len_thresh (40)
#
# Strategy: give ranges and study each variation at a time

if test -n "$suffix"; then
  suffix_subst="s%\(output_extension=\)\"[^\"]*\"%\1\"$suffix\"%g"
fi

if test -n "$edgesuffix"; then
  edgesuffix_subst="s%\(edge_extension=\)\"[^\"]*\"%\1\"$edgesuffix\"%g"
  existingedges_subst="s%\(use_existing_edges=\)\"[^\"]*\"%\1\"on\"%g"
fi

if test -n "$nrad"; then
  nrad_subst="s%\(Edge_Linking-nrad=\)\"[0-9]*\"%\1\"$nrad\"%g"
fi

if test -n "$num_link_iters"; then
  num_link_iters_subst="s%\(Edge_Linking-num_link_iters=\)\"[0-9]*\"%\1\"$num_link_iters\"%g"
fi

sed "s/@IMGEXT@/$img_ext/g
s/@IMGBASENAME@/$img_base/g
s/@INPUTDIR@/$img_dir/g
s/@OUTPUTDIR@/$img_dir/g
$suffix_subst
$edgesuffix_subst
$existingedges_subst
$nrad_subst
$num_link_iters_subst
" $xmlorig  > $tmpfile

set -x
$vorldirname -x $tmpfile
