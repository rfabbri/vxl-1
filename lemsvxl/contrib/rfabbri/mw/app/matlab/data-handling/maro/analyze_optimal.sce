// suffix O == Optimized
PO = list()

PO(1) = [1262.3228226080518652 59780.088653043771046 -152.24174831819246378 -461454407.260212183
264.21275790416086693 -149.16816356660976339 -59787.570416447924799 25586769.676642172039
-0.99921892920155386264 0.037123990678020746259 -0.013540341260051907968 16356.823348861938939];


PO(2) = [...
-43092.27598925287748 41448.919664657078101 564.30888974270180825 15096781.445295851678
-219.92062717481593381 597.81284811256523426 -59784.94702298023185 24412320.934895582497
-0.70474025331071832312 -0.70933633496096371029 -0.013532895761508678678 20107.99362233750071
];


PO(3) = [...
1223.7610883906868366 59778.813410221286176 -521.06802691051632337 -461238071.06008529663
-909.59558698458340587 -493.78023750871307129 -59779.381502064439701 33595530.737466216087
-0.99931393286551717381 0.036567809544631346697 0.0058701691594524041395 15797.998630853046052
];


PO(4) = [...
-43073.846615732894861 41471.858860986525542 65.545121142689609428 14919060.61429730989
-929.12219337839098898 -858.03990145163231773 -59774.962445002551249 39163983.300895996392
-0.70500007917348317399 -0.70910394157355693956 0.012103239658343423191 19536.463138148450525
];

// pts3d=myread('pts3d-optimized.dat');
// pts3d=matrix(pts3d,-1,3)
// format(20)

pts3dO = [...
   7539.5169151704049    7696.62294815191763   372.011966154728952
   7540.34628238484675   7686.73603796166117   358.274827444400444
   7540.28995061205296   7686.61962719974417   330.585821529618102
   7540.87605109192191   7707.18415184390324   330.35997655005059 
   7540.99720113750845   7707.26133033227416   358.238150159039037
   7540.54643078250592   7717.39469648285922   371.583628083801727
   7539.92367852953066   7722.20989855404787   371.655650711046633
   7540.06568411689386   7719.77201786693331   346.142677993149505
   7539.73887887307592   7722.75791691726045   335.669793998070816
   7539.41086483002164   7716.93820145570407   335.668555010958073
   7535.45754080204188   7719.58607197325455   341.109755369088418
   7513.43757054335401   7720.43941618188819   341.317501725368459
   6920.648267985438     7708.06651771305951   385.812480370757612
   7269.18522752753324   7295.33952485037207   364.418931177161312
   7232.03637032506686   7311.09774833124357   387.493588139760277
   7188.17367485176419   7364.33624353628602   333.4240508274533  
   7138.66474369889056   7421.35248768877409   381.115186382382547
   7150.62970214126108   7406.75822072322899   394.085061403705026
];


exec /Users/rfabbri/sciprg/toolbx/siptoolbox/macros/sip_rq.sci;
exec /Users/rfabbri/sciprg/toolbx/siptoolbox/macros/KRC_from_P.sci;
exec /Users/rfabbri/cprg/vxlprg/lemsvpe/lemsvxl/contrib/rfabbri/mw/app/matlab/utils/mywrite.sci;


RO = list();
CO = list();
KO = list();

for i=1:4
  [KOtmp, ROtmp, COtmp] = KRC_from_P(PO(i));
  KO(i) = KOtmp;
  CO(i) = COtmp;
  RO(i) = ROtmp;
  if (det(RO(i)) < 0)
    RO(i) = -RO(i);
  end
  // focal length
  f(i) = KO(i)(1,1)*pw;
  fconfirm(i) = KO(i)(2,2)*ph;
end

// remap world coordinates to align to 1st cam

ROnew = list();
POnew = list();

M = RO(1)'*R(1)
for i=1:4
  if (i == 1)
    ROnew(1) = R(1)
  else
    ROnew(i) = RO(i)*M
  end
  TOnew = -RO(i)*CO(i)   // translation vector stays invariant
  POnew(i) = KO(i)*[ROnew(i) TOnew]
  pts3d_new = pts3dO*M
end

// output to files
mkdir('newcam2')
for i=1:4
  fprintfMat('newcam2/' + string(i) + '.projmatrix', PO(i),'%30.30lf')
end
mywrite('newcam2/pts3d-optimized.dat', pts3dO);

//mkdir('newcam')
//for i=1:4
//  fprintfMat('newcam/' + string(i) + '.projmatrix', POnew(i),'%30.30lf')
//end
//mywrite('newcam/pts3d-optimized.dat', pts3d_new);

// check the transform didn't change coordinates

disp('proj before')

pts2dO = list()
for i=1:4
  pts2dO(i) = (PO(i)*[pts3dO ones(size(pts3dO,1),1)]')'
  pts2dO(i) = pts2dO(i)(:,1:2)./[pts2dO(i)(:,3) pts2dO(i)(:,3)]
end

pts2dOnew = list()
maxdif = zeros(1,4)
for i=1:4
  pts2dOnew(i) = (POnew(i)*[pts3d_new ones(size(pts3d_new,1),1)]')'
  pts2dOnew(i) = pts2dOnew(i)(:,1:2)./[pts2dOnew(i)(:,3) pts2dOnew(i)(:,3)]
  maxdif(i) = max(pts2dO(i) - pts2dOnew(i));
end

if max(maxdif) > 0.01
  disp('coord transform error!!!!!')
end
